from fastapi import FastAPI
from pydantic import BaseModel
from fastapi.middleware.cors import CORSMiddleware
import requests
from bs4 import BeautifulSoup

app = FastAPI()

# ë³´ì•ˆ ì„¤ì • (CORS): Vercel ë“± ì™¸ë¶€ ì ‘ì† í—ˆìš©
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class VideoRequest(BaseModel):
    url: str

def crawl_site(url: str):
    """
    URLì„ ë°›ì•„ì„œ ì œëª©, ë³¸ë¬¸, ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ëŠ” ìˆ˜ì§‘ë°˜
    """
    # 1. ë´‡ì´ ì•„ë‹Œ ì²™ ìœ„ì¥í•˜ê¸° (User-Agent ì„¤ì •)
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
    
    try:
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status() # ì ‘ì† ì—ëŸ¬ ì²´í¬
        
        # 2. HTML ë¶„ì„ ë„êµ¬(BS4) ê°€ë™
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # 3. ë°ì´í„° ì¶”ì¶œ
        # (1) ì œëª© ê°€ì ¸ì˜¤ê¸°
        title = soup.title.string if soup.title else "ì œëª© ì—†ìŒ"
        
        # (2) ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (img íƒœê·¸ ì°¾ê¸°)
        images = []
        for img in soup.find_all('img'):
            src = img.get('src')
            if src and src.startswith('http'):
                # ë„ˆë¬´ ì‘ì€ ì•„ì´ì½˜ì´ë‚˜ ë¡œê³ ëŠ” ì œì™¸ (í•„í„°ë§)
                images.append(src)
        
        # ìƒìœ„ 5ê°œ ì´ë¯¸ì§€ë§Œ ì„ íƒ (í…ŒìŠ¤íŠ¸ìš©)
        selected_images = images[:5]
        
        return {
            "status": "success",
            "title": title,
            "image_count": len(images),
            "images": selected_images
        }

    except Exception as e:
        return {"status": "error", "message": str(e)}

@app.get("/")
def read_root():
    return {"status": "Studio 100 Ton Crawler Ready", "ver": "2.0"}

@app.post("/ignite")
def ignite_engine(request: VideoRequest):
    print(f"ğŸ”¥ ìì¬ ìˆ˜ì§‘ ìš”ì²­: {request.url}")
    
    # í¬ë¡¤ë§ í•¨ìˆ˜ ì‹¤í–‰
    crawled_data = crawl_site(request.url)
    
    if crawled_data["status"] == "error":
        return {"message": "ìˆ˜ì§‘ ì‹¤íŒ¨", "error": crawled_data["message"]}
    
    print(f"âœ… ìˆ˜ì§‘ ì„±ê³µ: {crawled_data['title']}")
    print(f"ğŸ“¸ ì´ë¯¸ì§€ ë°œê²¬: {crawled_data['image_count']}ê°œ")

    return {
        "status": "processing",
        "message": f"ë¶„ì„ ì™„ë£Œ! ì œëª©: [{crawled_data['title']}] / ì´ë¯¸ì§€ {crawled_data['image_count']}ì¥ í™•ë³´",
        "data": crawled_data
    }
