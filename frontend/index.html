from fastapi import FastAPI
from pydantic import BaseModel
from fastapi.middleware.cors import CORSMiddleware
import requests
from bs4 import BeautifulSoup
import os
from dotenv import load_dotenv
from openai import OpenAI

# 1. ë¹„ë°€ ê¸ˆê³ (.env)ì—ì„œ ì—´ì‡ ë¥¼ êº¼ë‚´ GPTë¥¼ ì¤€ë¹„ì‹œí‚µë‹ˆë‹¤
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

app = FastAPI()

# ë³´ì•ˆ ì„¤ì • (CORS)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class VideoRequest(BaseModel):
    url: str

# --- [ê¸°ëŠ¥ 1] ìì¬ ìˆ˜ì§‘ë°˜ (ì‡¼í•‘ëª°/ë‰´ìŠ¤ ê¸ì–´ì˜¤ê¸°) ---
def crawl_site(url: str):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
    try:
        response = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # ì œëª© í™•ë³´
        title = soup.title.string if soup.title else "ì œëª© ì—†ìŒ"
        
        # ë³¸ë¬¸ í™•ë³´ (ë©”íƒ€ íƒœê·¸ ìš°ì„ , ì—†ìœ¼ë©´ ë³¸ë¬¸ í…ìŠ¤íŠ¸)
        content = ""
        meta_desc = soup.find("meta", property="og:description")
        if meta_desc:
            content = meta_desc["content"]
        
        if len(content) < 50: 
            content = soup.get_text()[:500].strip()

        # ì´ë¯¸ì§€ í™•ë³´
        images = []
        for img in soup.find_all('img'):
            src = img.get('src')
            if src and src.startswith('http'):
                images.append(src)
        
        return {"title": title, "content": content, "images": images[:5], "status": "success"}
    except Exception as e:
        return {"status": "error", "message": str(e)}

# --- [ê¸°ëŠ¥ 2] ëŒ€ë³¸ ì‘ê°€ (GPT-4o) ---
def generate_script(title, content):
    print("ğŸ¤– GPTê°€ ëŒ€ë³¸ì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...")
    
    # AIì—ê²Œ ì—­í• ì„ ë¶€ì—¬í•˜ëŠ” 'í”„ë¡¬í”„íŠ¸' (ì†ŒìŠ¤ 79ë²ˆ ì°¸ì¡°)
    prompt = f"""
    ë„ˆëŠ” 100ë§Œ ìœ íŠœë²„ì˜ 'ì‡¼ì¸  ëŒ€ë³¸ ì‘ê°€'ì•¼.
    ì•„ë˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ëŒë“¤ì´ ë‹¹ì¥ ì‚¬ê³  ì‹¶ê±°ë‚˜ í´ë¦­í•˜ê²Œ ë§Œë“œëŠ” 30ì´ˆ ëŒ€ë³¸ì„ ì¨ì¤˜.
    
    [ìƒí’ˆ/ê¸°ì‚¬ ì •ë³´]
    ì œëª©: {title}
    ë‚´ìš©: {content}
    
    [ì‘ì„± ì¡°ê±´]
    1. ì²« ë¬¸ì¥ì€ ë¬´ì¡°ê±´ ì‹œì„ ì„ ë„ëŠ” ê°•ë ¥í•œ 'í›„í‚¹(Hook)'ìœ¼ë¡œ ì‹œì‘í•  ê²ƒ.
    2. ì „ì²´ ê¸¸ì´ëŠ” ì½ì—ˆì„ ë•Œ ë”± 30ì´ˆ ë¶„ëŸ‰ìœ¼ë¡œ.
    3. ë§íˆ¬ëŠ” ì¹œê·¼í•˜ê³  í¥ë¶„ëœ í†¤ìœ¼ë¡œ ("~ëŒ€ë°•ì´ì£ ?", "~ë¯¸ì³¤ìŠµë‹ˆë‹¤" ë“±).
    4. ê²°ê³¼ëŠ” ì˜¤ì§ ëŒ€ë³¸ ë‚´ìš©ë§Œ ì¶œë ¥í•´. (ì„¤ëª… ê¸ˆì§€)
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o", 
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices.message.content
    except Exception as e:
        return f"ëŒ€ë³¸ ì‘ì„± ì‹¤íŒ¨: {str(e)}"

@app.get("/")
def read_root():
    return {"status": "Studio 100 Ton Brain Attached", "power": "Active"}

@app.post("/ignite")
def ignite_engine(request: VideoRequest):
    print(f"ğŸ”¥ ì‘ì—… ì‹œì‘: {request.url}")
    
    # 1. í¬ë¡¤ë§ (ì¬ë£Œ ìˆ˜ì§‘)
    data = crawl_site(request.url)
    if data["status"] == "error":
        return {"message": "í¬ë¡¤ë§ ì‹¤íŒ¨", "error": data["message"]}
    
    print(f"âœ… ë°ì´í„° í™•ë³´: {data['title']}")

    # 2. ëŒ€ë³¸ ì‘ì„± (AI ê°€ë™)
    script = generate_script(data['title'], data['content'])
    print(f"ğŸ“œ ëŒ€ë³¸ ì™„ì„±! (ì•ë¶€ë¶„): {script[:50]}...") 

    return {
        "status": "success",
        "message": "ëŒ€ë³¸ ì‘ì„± ì™„ë£Œ!",
        "crawled_title": data['title'],
        "script": script,  # ì™„ì„±ëœ ëŒ€ë³¸ì„ í™”ë©´ìœ¼ë¡œ ë³´ëƒ„
        "images": data['images']
    }
